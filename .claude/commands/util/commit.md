# Git コミット＆プッシュ＆プルリクエスト作成

ステージングされたファイルから適切なコミットメッセージを作成し、コミット、プッシュ、プルリクエスト作成までを一貫して行います。

## 概要

このコマンドは以下の処理を順次実行します：

1. ステージング状態の確認
2. 変更内容の分析とコミットメッセージ作成
3. コミット実行
4. リモートへのプッシュ
5. プルリクエスト作成

## 前提条件

- ファイルが既にステージング（`git add`）されていること
- GitHubリポジトリが設定されていること
- `gh` CLI がインストールされていること

---

## Phase 1. ステージング状態の確認

### 1-1. Git状態の取得

以下のgitコマンドを並列実行して情報を収集：

```bash
# 並列実行
git status
git diff --cached
git log -5 --oneline
git branch --show-current
```

### 1-2. ステージング確認

- ステージングされたファイルが存在しない場合はエラーメッセージを表示して終了

```markdown
❌ エラー: ステージングされたファイルがありません。

以下のコマンドでファイルをステージングしてから再実行してください：
\```bash
git add <ファイル名>
\```
```

- ステージングされたファイルがある場合は次のフェーズへ進む

---

## Phase 2. 変更内容の分析とコミットメッセージ作成

### 2-1. 変更内容の分析

`git diff --cached` の内容から以下を分析：

1. **変更の種類を判定**（最も適切なものを1つ選択）
   - `RELEASE`: 新規機能の追加
   - `FIX`: バグ修正
   - `DELETE`: コード・機能の削除
   - `REFACTOR`: リファクタリング

2. **変更されたファイル・モジュールの把握**
3. **変更の目的・理由の推測**
4. **影響範囲の特定**

### 2-2. コミットメッセージのドラフト作成

CLAUDE.mdの「コミットメッセージ書き方」に従い、以下の形式でドラフト作成：

```
[種別]: <変更内容の要約>

- 変更内容の詳細1
- 変更内容の詳細2
- 関連するファイルやモジュール
- 影響範囲や注意点

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

#### コミットメッセージ作成ガイドライン

- **タイトル**: 簡潔で明確に、何を変更したかを一行で表現（日本語）
- **本文**:
  - なぜその変更が必要だったか（WHY）
  - 何を変更したか（WHAT）
  - 関連するファイルやモジュール
  - 影響範囲や注意点
- **必須フッター**: Claude Code生成の署名を付与

### 2-3. ユーザへの確認

作成したコミットメッセージをユーザに提示して承認を得る：

```markdown
## 📝 作成されたコミットメッセージ

\```
[FIX]: ログイン時のバリデーションエラー修正

- usernameの最小文字数チェックが正しく動作していなかった問題を修正
- バリデーション条件を `x > 8` から `x >= 8` に変更
- LoginService.validateUsername() を修正
- 境界値テストケースを追加

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
\```

このメッセージでコミットしてよろしいですか？ (y/n)
修正が必要な場合は修正内容をお知らせください。
```

**ユーザの承認（y）が得られた場合のみ次フェーズへ進む。**

---

## Phase 3. コミット実行

### 3-1. コミットの実行

HEREDOCを使用してコミットメッセージを適用：

```bash
git commit -m "$(cat <<'EOF'
[種別]: 変更内容の要約

- 変更内容の詳細1
- 変更内容の詳細2

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

### 3-2. コミット結果の確認

```bash
git log -1 --format='%H %s'
git status
```

コミットが成功したことをユーザに通知：

```markdown
✅ コミットが完了しました

コミットハッシュ: abc123def456
```

---

## Phase 4. リモートへのプッシュ

### 4-1. リモートブランチの確認

現在のブランチがリモートを追跡しているか確認：

```bash
git branch -vv
```

### 4-2. プッシュの実行

- リモートブランチが存在する場合:
  ```bash
  git push
  ```

- リモートブランチが存在しない場合（初回プッシュ）:
  ```bash
  git push -u origin <ブランチ名>
  ```

### 4-3. プッシュ結果の確認

```markdown
✅ リモートへのプッシュが完了しました

ブランチ: feature/login-validation
```

---

## Phase 5. プルリクエスト作成

### 5-1. プルリクエスト情報の作成

#### ベースブランチの特定

- CLAUDE.mdのブランチ戦略に基づき、通常は 開発用ブランチ `dev/develop` をベースブランチとする
- ユーザに確認：

```markdown
## プルリクエストを作成します

ベースブランチ: main
現在のブランチ: feature/login-validation

このままプルリクエストを作成してよろしいですか？ (y/n)
ベースブランチを変更する場合は、ブランチ名を入力してください。
```

#### PRタイトルとボディの作成

- **タイトル**: コミットメッセージのタイトル部分を使用
- **ボディ**: コミットログから変更内容をまとめて記載

```markdown
## Summary
- JWT認証を実装
- ログイン・ログアウトエンドポイントを追加
- セッション管理機能を実装

## Test plan
- [ ] ログイン機能の動作確認
- [ ] ログアウト機能の動作確認
- [ ] セッション管理の動作確認
- [ ] 単体テストの実行
- [ ] 統合テストの実行

🤖 Generated with [Claude Code](https://claude.com/claude-code)
```

### 5-2. プルリクエストの作成

`gh` コマンドを使用してプルリクエストを作成：

```bash
gh pr create --title "[RELEASE]: ユーザー認証機能の追加" --body "$(cat <<'EOF'
## Summary
- JWT認証を実装
- ログイン・ログアウトエンドポイントを追加
- セッション管理機能を実装

## Test plan
- [ ] ログイン機能の動作確認
- [ ] ログアウト機能の動作確認
- [ ] セッション管理の動作確認
- [ ] 単体テストの実行
- [ ] 統合テストの実行

🤖 Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

### 5-3. プルリクエストURL の表示

作成されたプルリクエストのURLをユーザに提示：

```markdown
✅ プルリクエストを作成しました

📌 PR URL: https://github.com/user/repo/pull/123

レビュー依頼を送信してください。
```

---

## エラーハンドリング

### コミット失敗時

- pre-commitフックによる修正が発生した場合、1回のみリトライ
- 失敗理由をユーザに明示して終了

### プッシュ失敗時

- リモートとの差分がある場合は、ユーザに `git pull` を促す
- 認証エラーの場合は、GitHubの認証設定を確認するよう促す

### プルリクエスト作成失敗時

- `gh` CLI が未インストールの場合は、インストール方法を案内
- 既存のPRが存在する場合は、そのPR URLを表示

---

## 注意事項

- **MUST**: ステージングされたファイルのみをコミット対象とする
- **MUST**: コミットメッセージはCLAUDE.mdの規約に従う
- **MUST**: ユーザの承認を得てから各フェーズを実行する
- **NEVER**: ユーザの承認なしに強制プッシュ（`--force`）を実行しない
- **NEVER**: mainブランチへの直接プッシュは行わない

---

## 使用例

```bash
# ファイルをステージング
git add src/auth/login.py

# コミット＆プッシュ＆PR作成
/util:commit
```

---

## 参考

- CLAUDE.md: Gitブランチ戦略、コミットメッセージ書き方
- GitHub CLI: https://cli.github.com/
