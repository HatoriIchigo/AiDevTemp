# コンテキスト実行（Context Action）

`.context/` 配下のコンテキストファイルに基づいて、ドキュメント作成・実装を行うコマンドです。
専門エージェントを積極的に活用し、コンテキストに記載された要件を確実に実現します。

---

## 使用例

```bash
/context:action 20251127143000.md
```

または

```bash
/context:action .context/20251127143000.md
```

---

## 実行フロー

### Phase 1. コンテキストファイルの読み込みと理解

#### 1-1. コンテキストファイルの読み込み

引数で指定されたコンテキストファイルを読み込む：

- 引数が `YYYYMMDDhhmmss.md` 形式の場合 → `.context/YYYYMMDDhhmmss.md` として読み込み
- 引数がフルパスの場合 → そのまま読み込み
- ファイルが存在しない場合 → エラーメッセージを表示して終了

```markdown
❌ エラー: コンテキストファイルが見つかりません

指定されたファイル: .context/20251127143000.md

`.context/` ディレクトリを確認してください。
```

#### 1-2. コンテキスト内容の分析

コンテキストファイルから以下の情報を抽出：

1. **実装目的**: 何を実装するのか
2. **対象ファイル**: 実装・修正対象のファイル一覧
3. **参照ドキュメント**: 参照すべき設計書・仕様書
4. **実装方針**: TDD、コーディング規約、テスト方針など
5. **使用するエージェント**: 推奨されるエージェント
6. **終了条件**: 完了判定の条件
7. **ユーザへの質問事項**: 事前に確認すべき内容

#### 1-3. 実行計画の作成と表示

コンテキストに基づいて実行計画を作成し、ユーザに提示：

```markdown
## 📋 実行計画

### 目的
ユーザー認証機能の実装

### 対象ファイル
- `backend/src/auth/login.py` (新規)
- `backend/test/auth/test_login.py` (新規)
- `backend/src/auth/middleware.py` (修正)

### 実装方針
- TDD (RED → GREEN → REFACTOR)
- pytest使用
- カバレッジ80%以上

### 使用エージェント
- python-expert: Python実装
- code-explorer: 既存コード調査

### 実行ステップ
1. 参照ドキュメントの確認
2. 既存コードの調査（middleware.py）
3. TDD REDフェーズ: テストコード作成
4. TDD GREENフェーズ: 実装
5. TDD REFACTORフェーズ: リファクタリング
6. ビルド＆テスト実行
7. カバレッジ確認

---

この計画で実行してよろしいですか？ (y/n)
```

**ユーザの承認（y）が得られた場合のみ次フェーズへ進む。**

---

### Phase 2. 事前確認・情報収集

#### 2-1. ユーザへの確認事項のチェック

コンテキストファイルの「6. ユーザへの確認事項」セクションを確認：

##### 2-1-1. 確認事項の存在チェック

コンテキストに「6. ユーザへの確認事項」セクションが存在するか確認：

- **セクションが存在しない場合**: Phase 2-2へスキップ
- **セクションが存在する場合**: Phase 2-1-2へ進む

##### 2-1-2. 確認事項の記入状況チェック

「6. ユーザへの確認事項」セクション内の各質問項目について、回答が記入されているかチェック：

**チェック基準:**
- ✅ **記入済み**: 質問の後に具体的な回答が記載されている
- ❌ **未記入**: 質問のみで回答がない、または「→」のみ

**未記入項目がある場合の処理:**

```markdown
⚠️ コンテキストファイルに未記入の確認事項があります

以下の質問に対する回答がコンテキストファイルに記載されていません：

1. アクセストークンの有効期限は1時間でよろしいですか？それとも別の期間が必要ですか？
   【現在の状態】未記入

2. 既存のユーザーテーブルを使用しますか？それとも新規に作成しますか？
   【現在の状態】未記入

---

以下のいずれかを選択してください：

a) コンテキストファイルを修正して回答を記入する
b) ここで直接回答する
c) 確認事項をスキップして実装を続行する（非推奨）

選択 (a/b/c):
```

**選択肢の処理:**

- **a) コンテキストファイルを修正**: 実行を一時停止し、ユーザーに修正を促す
  ```markdown
  コンテキストファイルを修正してください。
  修正完了後、再度 `/context:action [ファイル名]` を実行してください。
  ```

- **b) ここで直接回答**: 各質問に対してユーザーから回答を受け取る
  ```markdown
  ## ❓ 確認事項への回答

  1. アクセストークンの有効期限は1時間でよろしいですか？それとも別の期間が必要ですか？
     → 【ユーザーの回答を待つ】

  2. 既存のユーザーテーブルを使用しますか？それとも新規に作成しますか？
     → 【ユーザーの回答を待つ】
  ```
  回答を受け取った後、Phase 2-2へ進む

- **c) スキップ**: 警告を表示して続行
  ```markdown
  ⚠️ 警告: 確認事項がスキップされました

  実装中に不明点が発生した場合、推測せずに必ず確認してください。
  ```
  Phase 2-2へ進む

##### 2-1-3. 全て記入済みの場合

確認事項が全て記入されている場合：

```markdown
✅ ユーザーへの確認事項

コンテキストファイルの確認事項は全て記入済みです：

1. アクセストークンの有効期限は1時間でよろしいですか？
   → 回答: 1時間で問題ありません

2. 既存のユーザーテーブルを使用しますか？
   → 回答: 既存のusersテーブルを使用します

確認内容に基づいて実装を進めます。
```

Phase 2-2へ進む

#### 2-2. 参照ドキュメントの確認

コンテキストに「参照ドキュメント」が記載されている場合、エージェントを使用して情報収集：

- **document-explorer エージェント** を使用
- 設計書・仕様書の内容を要約
- 実装に必要な情報を抽出

```markdown
## 📖 参照ドキュメントの確認

document-explorer エージェントを使用して `docs/design.md` を確認します...

【要約結果】
- 認証方式: JWT
- トークン有効期限: 1時間
- リフレッシュトークン: 7日間
...
```

#### 2-3. 既存コードの調査

修正対象のファイルがある場合、**code-explorer エージェント** を使用して調査：

```markdown
## 🔍 既存コードの調査

code-explorer エージェントを使用して `backend/src/auth/middleware.py` を調査します...

【調査結果】
- 現在の認証ミドルウェア実装状況
- 依存関係
- 修正が必要な箇所
...
```

---

### Phase 3. 実装の実行

#### 3-1. TodoList の作成

TodoWriteツールを使用して、実装タスクを管理：

```json
[
  {"content": "参照ドキュメントの確認", "status": "completed", "activeForm": "参照ドキュメントを確認中"},
  {"content": "既存コードの調査", "status": "completed", "activeForm": "既存コードを調査中"},
  {"content": "TDD REDフェーズ: テストコード作成", "status": "in_progress", "activeForm": "テストコードを作成中"},
  {"content": "TDD GREENフェーズ: 実装", "status": "pending", "activeForm": "実装中"},
  {"content": "TDD REFACTORフェーズ: リファクタリング", "status": "pending", "activeForm": "リファクタリング中"},
  {"content": "ビルド＆テスト実行", "status": "pending", "activeForm": "ビルド＆テスト実行中"},
  {"content": "カバレッジ確認", "status": "pending", "activeForm": "カバレッジを確認中"}
]
```

#### 3-2. 専門エージェントの活用

コンテキストに記載された「使用するエージェント」を優先的に使用：

- **Python実装**: `python-expert` エージェント
- **Java実装**: `java-expert` エージェント
- **コード調査**: `code-explorer` エージェント
- **ドキュメント調査**: `document-explorer` エージェント
- **タスク分析**: `task-reasoning-analyzer` エージェント

エージェントに対して、コンテキスト情報を含めて指示：

```markdown
@python-expert

以下のコンテキストに基づいてログイン機能を実装してください：

【コンテキスト要約】
- 実装ファイル: backend/src/auth/login.py
- テストファイル: backend/test/auth/test_login.py
- 実装方針: TDD、pytest使用
- コーディング規約: 1行120文字以内、関数名はスネークケース

【テストケース】
1. ログイン成功
   - given: username="testuser", password="password123"
   - when: login(username, password)
   - then: トークンが返される
...

上記に基づいてTDD REDフェーズのテストコードを作成してください。
```

#### 3-3. 段階的な実装

コンテキストに記載された順序で段階的に実装：

1. **TDD REDフェーズ**: テストコードを作成（失敗することを確認）
2. **TDD GREENフェーズ**: テストがパスする最小限の実装
3. **TDD REFACTORフェーズ**: リファクタリング
4. **ビルド＆テスト**: 全体のテスト実行
5. **カバレッジ確認**: カバレッジ目標の達成確認

各フェーズ完了時に、TodoListを更新して進捗を可視化。

---

### Phase 4. 検証と終了

#### 4-1. 終了条件の確認

コンテキストに記載された「終了条件」をすべて確認：

```markdown
## ✅ 終了条件の確認

- [x] ログイン機能の実装が完了していること
- [x] テストが全てパスすること
- [x] カバレッジが80%以上であること
- [x] コーディング規約に準拠していること

すべての終了条件を満たしました。
```

#### 4-2. 実装結果のサマリ表示

```markdown
## 🎉 実装完了

### 作成・修正したファイル
- `backend/src/auth/login.py` (新規作成)
- `backend/test/auth/test_login.py` (新規作成)
- `backend/src/auth/middleware.py` (修正)

### テスト結果
- 全テストケース: 15件
- 成功: 15件
- 失敗: 0件
- カバレッジ: 85%

### 次のステップ
1. コードレビューの実施
2. 統合テストの実行
3. ステージング環境へのデプロイ
```

---

## エージェント活用ガイドライン

### 優先的に使用するエージェント

| 状況 | 使用エージェント | 理由 |
|------|----------------|------|
| Python実装 | `python-expert` | Python特化の専門知識 |
| Java実装 | `java-expert` | Java特化の専門知識 |
| コード調査 | `code-explorer` | ソースコード探索・要約に特化 |
| ドキュメント調査 | `document-explorer` | ドキュメント探索・要約に特化 |
| タスク分析 | `task-reasoning-analyzer` | 必要なタスク・ファイルの推論 |
| Git操作 | `git-expert` | Git操作の専門家 |

### エージェント使用時の注意事項

- **コンテキスト情報の共有**: エージェントに対して、コンテキストファイルの内容を要約して伝える
- **明確な指示**: 何を期待しているか明確に伝える
- **結果の検証**: エージェントの出力を検証し、コンテキストの要件を満たしているか確認

---

## 重要な制約事項

### ファイル編集の制御

- **MUST**: コンテキストに記載されたファイルのみ編集する
- **NEVER**: 記載されていないファイルを勝手に修正しない
- **SHOULD**: どうしても修正が必要な場合はユーザに確認を求める

```markdown
⚠️ 確認が必要です

コンテキストに記載されていない以下のファイルの修正が必要です：
- `backend/src/config.py`

理由: 認証設定を追加する必要があるため

修正してよろしいですか？ (y/n)
```

### 順次実行の徹底

- **MUST**: コンテキストに記載された順序で実装を行う
- **NEVER**: 順序を勝手に変更しない
- **SHOULD**: 順序変更が必要な場合はユーザに確認

### エラーハンドリング

実装中にエラーが発生した場合：

1. エラー内容を明確に提示
2. 原因の分析
3. 解決策の提案
4. ユーザに確認を求める

```markdown
❌ エラーが発生しました

【エラー内容】
ModuleNotFoundError: No module named 'pytest'

【原因】
pytestがインストールされていません。

【解決策】
以下のコマンドでpytestをインストールします：
\```bash
pip install pytest
\```

実行してよろしいですか？ (y/n)
```

---

## 実行例

### コンテキストファイル例

```markdown
# コンテキスト: ログイン機能実装

## 1. 背景・目的
ユーザー認証機能を実装する

## 2. 実装ファイル
- backend/src/auth/login.py (新規)
- backend/test/auth/test_login.py (新規)

## 3. 実装方針
- TDD
- pytest使用

## 4. 使用するエージェント
- python-expert

## 5. 終了条件
- [ ] ログイン機能の実装完了
- [ ] テスト全てパス
```

### 実行コマンド

```bash
/context:action 20251127143000.md
```

### 実行結果

1. コンテキスト読み込み → 実行計画表示 → ユーザ承認
2. python-expert エージェント起動 → TDD RED フェーズ実装
3. python-expert エージェント起動 → TDD GREEN フェーズ実装
4. テスト実行 → 全テストパス確認
5. 終了条件確認 → 完了報告

---

## 参考

- コンテキスト作成: `/context:create`
- CLAUDE.md: コンテキスト駆動開発について