# コンテキストファイル 生成ルール

## 1. 📝 記述の明確性
- [ ] 曖昧な表現がないか（「できれば」「なるべく」「適切な」など）
- [ ] 具体的な数値・基準が明示されているか
- [ ] 専門用語に説明があるか

## 2. 📋 情報の完全性
- [ ] 実装目的が明確に記載されているか
- [ ] 対象ファイルが全て列挙されているか（新規/修正の区別）
- [ ] 参照ドキュメントが実際に存在するか
- [ ] 機能要件・非機能要件が明確に記載されているか
- [ ] テストケースが十分に定義されているか
- [ ] より具体的な条件が書いてあるか（✖ パスワードが正しい、〇 `ABCDEFG`）
- [ ] 終了条件が測定可能か

## 3. 🎯 コンテキストの適切性
- [ ] 目的に直接関係ない情報が含まれていないか
- [ ] 新規実装の場合、実装コード例が含まれていないか
- [ ] リファクタの場合、必要最低限のコードのみが含まれているか
- [ ] 必要最低限の情報のみに絞られているか

## 4. 🏗️ 実装方針の妥当性
- [ ] 開発手法（TDD等）が明記されているか
- [ ] コーディング規約が具体的か
- [ ] 外部依存が明示されているか

## 5. ✅ テストケースの十分性
- [ ] given-when-thenで記述されているか
- [ ] 正常系・異常系が網羅されているか
- [ ] 境界値テストが含まれているか

## 6. 📚 参照情報の妥当性
- [ ] 参照ドキュメントが存在確認済みか
- [ ] 使用するエージェントが実際に存在するか
- [ ] 関連する過去の議論が参照されているか

---

## コンテキスト例

```markdown
# コンテキスト：ログイン実装

## 1. 目的・背景

### 実装目的
- ユーザー認証機能（ログインAPI）の実装
- セキュアなログイン処理の提供
- JWT方式によるトークン認証の実装

### ビジネス要件
- ユーザーがメールアドレスとパスワードでログインできること
- 認証成功時にJWTトークンを発行すること
- セキュリティベストプラクティス（OWASP準拠）に準拠すること

---

## 2. 機能要件

### 2.1 ログイン処理
- **認証方式**: メールアドレス + パスワード
- **入力検証**:
  - メールアドレス: 必須、形式チェック（RFC 5322準拠）
  - パスワード: 必須、最小8文字
- **認証処理**:
  - データベースから該当メールアドレスのユーザーを取得
  - パスワードハッシュとの照合（bcrypt使用）
  - 認証成功時にJWTトークンを生成
- **レスポンス**:
  - 成功時（HTTP 200）: JWT + ユーザー情報（id, email）
  - 失敗時（HTTP 401）: 統一エラーメッセージ

### 2.2 JWT仕様
- **アルゴリズム**: HS256（HMAC-SHA256）
- **有効期限**: 24時間
- **ペイロード**: ユーザーID、メールアドレス、有効期限
- **署名鍵**: 環境変数から取得（`JWT_SECRET_KEY`）

### 2.3 エラーハンドリング
- **統一エラーメッセージ**: 「メールアドレスまたはパスワードが正しくありません」（アカウント列挙攻撃対策）
- **レート制限**: 同一IPから5分間に5回まで（超過時: HTTP 429）
- **バリデーションエラー**: HTTP 422（FastAPI標準形式）

---

## 3. 非機能要件

### 3.1 セキュリティ
- **パスワード照合**: bcrypt使用
- **JWT署名**: HS256アルゴリズム、環境変数で秘密鍵を管理
- **入力検証**: FastAPIのPydanticバリデーション使用
- **SQLインジェクション対策**: ORMのパラメータバインディング使用（生SQLは禁止）
- **レート制限**: slowapi使用（5分間に5回まで）

### 3.2 パフォーマンス
- **ログイン処理**: 500ms以内（95パーセンタイル）
- **同時接続**: 100リクエスト/秒対応

---

## 4. 技術要件

- **言語**: Python 3.11+
- **Webフレームワーク**: FastAPI
- **JWT**: PyJWT
- **パスワード照合**: bcrypt
- **レート制限**: slowapi
- **テスト**: pytest, pytest-asyncio
- **データベース**: SQLAlchemy（ORM）
- **環境変数管理**: pydantic-settings

その他ライブラリは`requirements.txt`を参照してください。

---

## 5. API仕様

### 5.1 ログインエンドポイント

**エンドポイント**: `POST /api/auth/login`

#### リクエスト仕様
- **Content-Type**: `application/json`
- **必須フィールド**:
  - `email` (string): メールアドレス（RFC 5322準拠）
  - `password` (string): パスワード（最小8文字）

#### レスポンス仕様

| HTTPステータス | 説明 | 含まれるフィールド |
|--------------|------|------------------|
| 200 OK | 認証成功 | `token` (JWT文字列), `user` (id, email) |
| 401 Unauthorized | 認証失敗 | `detail` (統一エラーメッセージ) |
| 422 Unprocessable Entity | バリデーションエラー | `detail` (FastAPI標準形式) |
| 429 Too Many Requests | レート制限超過 | `detail` (エラーメッセージ) |

詳細なスキーマ定義はPydanticスキーマで実装する。

---

## 6. 対象ファイル

- `backend/src/routers/auth.py` - 認証APIルーター
- `backend/tests/test_auth_api.py` - 認証APIの結合テスト

---

## 7. テスト要件（TDD）

### 7.1 開発手法
- **TDD（テスト駆動開発）**: Red-Green-Refactorサイクル厳守
- **テストファースト**: 実装前に必ずテストを書く
- **カバレッジ目標**: 90%以上（ただし、常に**100%を目指す**。90%を超過したからOKとしない）

## 7.2 テストケース

### 正常系テスト
1. ログイン成功
    **given**:
        - `username`: `test_user_01`
        - `password`: `password`
    **when**:
        - ログイン処理を実行
    **then**
        - HTTP 200
2. その他正常系テスト...

### 異常系テスト
1. ログイン失敗
    **given**:
        - `username`: `test_user_01`
        - `password`: `invalid_password`
    **when**:
        - ログイン処理を実行
    **then**
        - HTTP 401
2. ...

### 境界値テスト
1. パスワードが空文字
    **given**:
        - `username`: `test_user_01`
        - `password`: ``
    **when**:
        - ログイン処理を実行
    **then**
        - HTTP 422

2. その他境界値テスト...

---

## 8. 制約事項・前提条件

- ログイン機能のみ実装
- パスワードリセット機能は対象外
- 2要素認証は対象外
- ソーシャルログインは対象外

---

## 9. 実装方針

### 9.1 開発手法
- **TDD（テスト駆動開発）**: Red-Green-Refactorサイクル厳守
- **テストファースト**: 実装前に必ずテストを書く
- **シンプル・イズ・ベスト**: 最初はベタ書きで実装、リファクタリングフェーズで洗練

### 9.2 コーディング規約
- **PEP 8準拠**: Pythonコーディング規約
- **型ヒント必須**: 全関数に型ヒント（typing）を付ける
- **Docstring**: 全パブリック関数にGoogle形式のdocstringを記載
- **命名規則**:
  - 関数・変数: `snake_case`
  - クラス: `PascalCase`
  - 定数: `UPPER_SNAKE_CASE`

### 9.3 使用する専門エージェント
- **python-expert**: Python実装の設計・レビュー支援
- **code-explorer**: 既存コードとの整合性確認
- **git-expert**: コミットメッセージ作成・Git操作支援

### 9.4 品質基準
- **テストカバレッジ**: 90%以上
- **単体テスト**: リファクタリング後に作成された全パブリック関数をテスト
- **結合テスト**: 全APIエンドポイントをテスト
- **Linter**: ruff使用（エラー0件）

---

## 11. 終了条件

以下の全条件を満たした時点で完了とする:

- [ ] 全テストケース（TC-I-001〜010、リファクタリング後の単体テスト）が実装され、全てパスする
- [ ] テストカバレッジが90%以上
- [ ] ログインAPI（`POST /api/auth/login`）が正常に動作する
- [ ] JWT生成・検証処理が正しく実装されている
- [ ] パスワード照合がbcryptで実装されている
- [ ] レート制限（5分間に5回）が実装され、機能する
- [ ] バリデーションエラーが適切に返される（HTTP 422）
- [ ] 統一エラーメッセージが実装されている（アカウント列挙攻撃対策）
- [ ] ruffによるLintエラーが0件
- [ ] 全パブリック関数に型ヒントとdocstringが記載されている
- [ ] 環境変数設定ファイル（`.env.example`）が作成されている
- [ ] 依存パッケージが`requirements.txt`に記載されている

```